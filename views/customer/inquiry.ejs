<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>ê³ ê°ì„¼í„°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ğŸ“Œ jQuery CDN ì¶”ê°€ -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .inquiry-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.05rem 0.15rem rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }

        .inquiry-item.resolved {
            background-color: #e2f0d9; /* í•´ê²°ë¨ */
            border-color: #a7d9b5;
        }

        .inquiry-item.resolved .inquiry-content {
            text-decoration: line-through; /* ì‘ëŒ€ê¸° ê¸‹ê¸° */
            color: #6c757d;
        }

        .inquiry-meta {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.75rem;
        }

        .inquiry-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .inquiry-content {
            white-space: pre-wrap;
            margin-bottom: 1rem;
        }

        .comment-section {
            background-color: #fff;
            border-top: 1px dashed #e9ecef;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .comment-list {
            list-style: none;
            padding: 0;
        }

        .comment-item {
            background-color: #f0f2f5;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem; /* í°ìƒ‰ ì˜ì—­ í¬ê¸° ì¡°ì • */
            margin-bottom: 0.5rem;
        }

        .comment-item-meta {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.25rem;
        }
        .comment-pagination-info {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        /* ğŸ“Œ ëŒ“ê¸€ ìˆ˜ì • í¼ ìˆ¨ê¹€ CSS */
        .edit-comment-area {
            display: none;
        }
        /* ğŸ“Œ ë¬¸ì˜ê¸€ ìˆ˜ì • í¼ ìˆ¨ê¹€ CSS */
        .edit-inquiry-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #e9f5ff; /* ìˆ˜ì • í¼ ë°°ê²½ìƒ‰ */
            border-radius: 0.5rem;
            border: 1px solid #cceeff;
        }
    </style>
</head>

<body>
    <!-- ìƒë‹¨ include -->
    <%- include('../ins/top') %>

    <div class="container w-75 mt-5 mx-auto">
        <!-- ğŸ“Œ ì œëª©ê³¼ ë²„íŠ¼ì„ ê°™ì€ ì¤„ì— ë°°ì¹˜í•˜ê¸° ìœ„í•œ d-flexì™€ justify-content-between ì‚¬ìš© -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">ê³ ê°ì„¼í„° - ê¸°ëŠ¥ ì œì•ˆ ë° ë¶ˆë§Œì‚¬í•­</h2>
            <!-- ğŸ“Œ ìƒˆë¡œìš´ ë¬¸ì˜ ì‘ì„± ë²„íŠ¼ -->
            <button class="btn btn-info" id="toggleFormBtn">
                ìƒˆë¡œìš´ ë¬¸ì˜ ì‘ì„±í•˜ê¸°
            </button>
        </div>
        
        <hr /> <!-- ğŸ“Œ hr íƒœê·¸ëŠ” ì œëª©ê³¼ ë²„íŠ¼ ì•„ë˜ì— ìœ„ì¹˜ -->

        <!-- ğŸ“Œ ë¶ˆë§Œì‚¬í•­/ì œì•ˆ ë“±ë¡ í¼ (hr ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™) -->
        <!-- jQueryëŠ” display:none ëŒ€ì‹  .hide()ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ì´ˆê¸° ìƒíƒœë¥¼ ìˆ¨ê¸¸ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. -->
        <div id="newInquiryForm" class="card p-4 mb-4 shadow-sm">
            <h4 class="mb-3">ìƒˆë¡œìš´ ë¬¸ì˜ ë“±ë¡</h4>
            <div class="mb-3">
                <label for="inquiryAuthor" class="form-label">ì‘ì„±ì</label>
                <input type="text" class="form-control" id="inquiryAuthor" placeholder="ì‘ì„±ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="mb-3">
                <label for="inquiryTitle" class="form-label">ì œëª©</label>
                <input type="text" class="form-control" id="inquiryTitle" placeholder="ë¬¸ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="mb-3">
                <label for="inquiryContent" class="form-label">ë‚´ìš©</label>
                <textarea class="form-control" id="inquiryContent" rows="4" placeholder="ë¶ˆë§Œì‚¬í•­ì´ë‚˜ ì œì•ˆ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitInquiry()">ë¬¸ì˜ ë“±ë¡</button>
            <button class="btn btn-secondary mt-2" id="closeFormBtn">ë‹«ê¸°</button>
        </div>

        <!-- ğŸ“Œ ë“±ë¡ëœ ë¬¸ì˜ ëª©ë¡ (í¼ ë°”ë¡œ ì•„ë˜ì— ìœ„ì¹˜) -->
        <!-- ğŸ“Œ ë“±ë¡ëœ ë¬¸ì˜ í—¤ë”© ìˆ˜ì •: ë¬¸ì˜ ê±´ìˆ˜ê°€ 0ì¼ ë•Œ ê´„í˜¸ ì‚¬ë¼ì§€ê²Œ í•¨ -->
        <h3 class="mb-4">ë“±ë¡ëœ ë¬¸ì˜ <span id="inquiryCountText"></span></h3>
        <div class="alert alert-info text-center" id="noInquiriesMessage" style="display:none;">
            ë“±ë¡ëœ ë¬¸ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë¬¸ì˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!
        </div>
        <div id="inquiryList">
            <!-- ë¬¸ì˜ ì‚¬í•­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
        </div>
    </div>

    <!-- bottom include -->
    <%- include('../ins/bottom') %>

    <script>
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (ë³´ì•ˆì„ ìœ„í•´ ì‚¬ìš©ì ì…ë ¥ ë‚´ìš© í‘œì‹œ ì „ ì‚¬ìš©)
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // ğŸ“Œ jQueryë¥¼ ì‚¬ìš©í•˜ì—¬ í¼ í† ê¸€ ê¸°ëŠ¥ êµ¬í˜„
        $(document).ready(function() {
            // í¼ì„ ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€
            $('#newInquiryForm').hide(); 

            // 'ìƒˆë¡œìš´ ë¬¸ì˜ ì‘ì„±í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ í¼ í† ê¸€
            $('#toggleFormBtn').on('click', function() {
                $('#newInquiryForm').slideToggle(); // ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¼ì´ë“œ í† ê¸€ íš¨ê³¼
            });

            // 'ë‹«ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ìˆ¨ê¹€
            $('#closeFormBtn').on('click', function() {
                $('#newInquiryForm').slideUp(); // ë¶€ë“œëŸ½ê²Œ í¼ì„ ìœ„ë¡œ ìŠ¬ë¼ì´ë“œí•˜ì—¬ ìˆ¨ê¹€
            });
        });
        
        // ë¶ˆë§Œì‚¬í•­/ì œì•ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchInquiries() {
            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries`);
                if (response.ok) {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        const inquiries = await response.json();
                        console.log('>>> fetched inquiries data (JSON):', inquiries);
                        renderInquiries(inquiries);
                    } else {
                        const textResponse = await response.text();
                        console.error('>>> Received non-JSON response from /customer/inquiries (Content-Type:', contentType, '):', textResponse);
                        document.getElementById('noInquiriesMessage').style.display = 'block';
                        alert('ì˜¤ë¥˜: ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ê°œë°œì ë„êµ¬ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('>>> Failed to fetch inquiries (HTTP Status:', response.status, 'Response Text:', errorText);
                    document.getElementById('noInquiriesMessage').style.display = 'block';
                    alert(`ë¬¸ì˜ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: HTTP ìƒíƒœ ${response.status}. ê°œë°œì ë„êµ¬ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                }
            } catch (error) {
                console.error('>>> Network error during fetchInquiries:', error);
                document.getElementById('noInquiriesMessage').style.display = 'block';
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ë¬¸ì˜ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¶ˆë§Œì‚¬í•­/ì œì•ˆ ë Œë”ë§
        function renderInquiries(inquiries) {
            console.log('>>> renderInquiries called with:', inquiries);
            const inquiryListDiv = document.getElementById('inquiryList');
            inquiryListDiv.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
            
            // ğŸ“Œ ë“±ë¡ëœ ë¬¸ì˜ ê±´ìˆ˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë¡œì§ ë³€ê²½
            const inquiryCountTextSpan = document.getElementById('inquiryCountText');
            if (inquiries.length > 0) {
                inquiryCountTextSpan.textContent = `(${inquiries.length}ê±´)`;
            } else {
                inquiryCountTextSpan.textContent = ''; // ë¬¸ì˜ê°€ ì—†ìœ¼ë©´ ê´„í˜¸ë„ í•¨ê»˜ ì œê±°
            }
            
            if (inquiries.length === 0) {
                document.getElementById('noInquiriesMessage').style.display = 'block';
                console.log('>>> No inquiries found, displaying message.');
                return;
            } else {
                document.getElementById('noInquiriesMessage').style.display = 'none';
            }

            inquiries.forEach(inquiry => {
                console.log('>>> Rendering inquiry:', inquiry);
                const inquiryItem = document.createElement('div');
                inquiryItem.className = `inquiry-item ${inquiry.resolved ? 'resolved' : ''}`;
                inquiryItem.id = `inquiry-${inquiry._id}`;

                inquiryItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="inquiry-title" id="inquiryTitleDisplay-${inquiry._id}">${escapeHTML(inquiry.title)}</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="resolvedCheck-${inquiry._id}" 
                                ${inquiry.resolved ? 'checked' : ''} 
                                onclick="toggleResolved('${inquiry._id}', this.checked)">
                            <label class="form-check-label" for="resolvedCheck-${inquiry._id}">
                                í•´ê²°ë¨
                            </label>
                        </div>
                    </div>
                    <div class="inquiry-meta">
                        ì‘ì„±ì: <strong id="inquiryAuthorDisplay-${inquiry._id}">${escapeHTML(inquiry.author)}</strong> | ë“±ë¡ì¼: ${new Date(inquiry.createdAt).toLocaleString()}
                        <button class="btn btn-sm btn-danger float-end ms-2" onclick="deleteInquiry('${inquiry._id}')">ì‚­ì œ</button>
                        <button class="btn btn-sm btn-warning float-end" onclick="toggleInquiryEditMode('${inquiry._id}')">ìˆ˜ì •</button> <!-- ğŸ“Œ ë¬¸ì˜ê¸€ ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€ -->
                    </div>
                    <p class="inquiry-content" id="inquiryContentDisplay-${inquiry._id}">${escapeHTML(inquiry.content)}</p>

                    <!-- ğŸ“Œ ë¬¸ì˜ê¸€ ìˆ˜ì • í¼ (ê° ë¬¸ì˜ê¸€ ë‚´ë¶€ì— ì¶”ê°€) -->
                    <div class="edit-inquiry-form" id="editInquiryForm-${inquiry._id}">
                        <h6 class="mb-3">ë¬¸ì˜ê¸€ ìˆ˜ì •</h6>
                        <div class="mb-2">
                            <label for="editInquiryAuthor-${inquiry._id}" class="form-label">ì‘ì„±ì</label>
                            <input type="text" class="form-control" id="editInquiryAuthor-${inquiry._id}">
                        </div>
                        <div class="mb-2">
                            <label for="editInquiryTitle-${inquiry._id}" class="form-label">ì œëª©</label>
                            <input type="text" class="form-control" id="editInquiryTitle-${inquiry._id}">
                        </div>
                        <div class="mb-2">
                            <label for="editInquiryContent-${inquiry._id}" class="form-label">ë‚´ìš©</label>
                            <textarea class="form-control" id="editInquiryContent-${inquiry._id}" rows="4"></textarea>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button class="btn btn-success btn-sm" onclick="saveInquiryEdit('${inquiry._id}')">ì €ì¥</button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelInquiryEdit('${inquiry._id}')">ì·¨ì†Œ</button>
                        </div>
                    </div>

                    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
                    <div class="comment-section">
                        <h6><span id="commentCountDisplay-${inquiry._id}"></span></h6>
                        <ul id="commentList-${inquiry._id}" class="comment-list">
                            <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
                        </ul>
                        <!-- ğŸ“Œ ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´ ë° ì»¨í…Œì´ë„ˆ -->
                        <div id="commentPaginationInfo-${inquiry._id}" class="comment-pagination-info"></div>
                        <nav aria-label="Comment pagination" class="comment-pagination-nav">
                            <ul class="pagination pagination-sm justify-content-center mt-3" id="commentPagination-${inquiry._id}">
                                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
                            </ul>
                        </nav>
                        <div class="input-group mt-1">
                            <input type="text" class="form-control form-control-sm" id="commentInput-${inquiry._id}" placeholder="ê´€ë¦¬ì ë‹µê¸€..." required>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="submitComment('${inquiry._id}')">ë“±ë¡</button>
                        </div>
                    </div>
                `;
                inquiryListDiv.appendChild(inquiryItem);
                
                // ëŒ“ê¸€ ë¡œë“œ (AJAX) - ì´ˆê¸° í˜ì´ì§€ëŠ” 1í˜ì´ì§€
                fetchComments(inquiry._id, 1);
            });
        }

        // ë¶ˆë§Œì‚¬í•­/ì œì•ˆ ë“±ë¡ (ê¸°ì¡´ê³¼ ë™ì¼)
        async function submitInquiry() {
            const author = document.getElementById('inquiryAuthor').value.trim();
            const title = document.getElementById('inquiryTitle').value.trim();
            const content = document.getElementById('inquiryContent').value.trim();

            if (!author || !title || !content) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, title, content })
                });

                if (response.ok) {
                    document.getElementById('inquiryAuthor').value = '';
                    document.getElementById('inquiryTitle').value = '';
                    document.getElementById('inquiryContent').value = '';
                    fetchInquiries(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    $('#newInquiryForm').slideUp(); // ğŸ“Œ jQuery ì‚¬ìš©í•˜ì—¬ í¼ ìˆ¨ê¸°ê¸°
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('ë¬¸ì˜ ë“±ë¡ ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ë¬¸ì˜ ë“±ë¡ ì‹¤íŒ¨:', response.status, errorData);
                }
            } catch (error) {
                console.error('ë¬¸ì˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ë¬¸ì˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¶ˆë§Œì‚¬í•­/ì œì•ˆ í•´ê²° ìƒíƒœ í† ê¸€ (ê¸°ì¡´ê³¼ ë™ì¼)
        async function toggleResolved(inquiryId, isResolved) {
            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}/resolve`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resolved: isResolved })
                });

                if (response.ok) {
                    const inquiryItem = document.getElementById(`inquiry-${inquiryId}`);
                    if (isResolved) {
                        inquiryItem.classList.add('resolved');
                    } else {
                        inquiryItem.classList.remove('resolved');
                    }
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('í•´ê²° ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('í•´ê²° ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', response.status, errorData);
                    document.getElementById(`resolvedCheck-${inquiryId}`).checked = !isResolved;
                }
            } catch (error) {
                console.error('í•´ê²° ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ í•´ê²° ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                document.getElementById(`resolvedCheck-${inquiryId}`).checked = !isResolved;
            }
        }

        // ë¶ˆë§Œì‚¬í•­/ì œì•ˆ ì‚­ì œ (ê¸°ì¡´ê³¼ ë™ì¼)
        async function deleteInquiry(inquiryId) {
            if (!confirm('ì •ë§ë¡œ ì´ ë¬¸ì˜ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ëŒ“ê¸€ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }
            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('ë¬¸ì˜ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    fetchInquiries(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('ë¬¸ì˜ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ë¬¸ì˜ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:', response.status, errorData);
                }
            } catch (error) {
                console.error('ë¬¸ì˜ì‚¬í•­ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ë¬¸ì˜ì‚¬í•­ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ğŸ“Œ ë¬¸ì˜ê¸€ ìˆ˜ì • ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
        function toggleInquiryEditMode(inquiryId) {
            const displayTitle = document.getElementById(`inquiryTitleDisplay-${inquiryId}`);
            const displayAuthor = document.getElementById(`inquiryAuthorDisplay-${inquiryId}`);
            const displayContent = document.getElementById(`inquiryContentDisplay-${inquiryId}`);
            const editForm = document.getElementById(`editInquiryForm-${inquiryId}`);

            const editTitle = document.getElementById(`editInquiryTitle-${inquiryId}`);
            const editAuthor = document.getElementById(`editInquiryAuthor-${inquiryId}`);
            const editContent = document.getElementById(`editInquiryContent-${inquiryId}`);

            // í˜„ì¬ ë‚´ìš©ì„ ìˆ˜ì • í¼ì— ì±„ìš°ê¸°
            editTitle.value = displayTitle.textContent;
            editAuthor.value = displayAuthor.textContent;
            editContent.value = displayContent.textContent;

            // jQueryë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ í† ê¸€
            $(displayTitle).closest('.inquiry-item').find('.inquiry-content').hide(); // ì›ë˜ ë‚´ìš©ì„ ìˆ¨ê¹€
            $(editForm).slideToggle(); // ìˆ˜ì • í¼ í† ê¸€
        }

        // ğŸ“Œ ë¬¸ì˜ê¸€ ìˆ˜ì • ì·¨ì†Œ í•¨ìˆ˜
        function cancelInquiryEdit(inquiryId) {
            const displayTitle = document.getElementById(`inquiryTitleDisplay-${inquiryId}`);
            const editForm = document.getElementById(`editInquiryForm-${inquiryId}`);

            // jQueryë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶€ë“œëŸ½ê²Œ ìˆ¨ê¹€
            $(editForm).slideUp(); // ìˆ˜ì • í¼ ìˆ¨ê¹€
            $(displayTitle).closest('.inquiry-item').find('.inquiry-content').show(); // ì›ë˜ ë‚´ìš© ë‹¤ì‹œ í‘œì‹œ
        }

        // ğŸ“Œ ë¬¸ì˜ê¸€ ìˆ˜ì • ì €ì¥ í•¨ìˆ˜
        async function saveInquiryEdit(inquiryId) {
            const updatedTitle = document.getElementById(`editInquiryTitle-${inquiryId}`).value.trim();
            const updatedAuthor = document.getElementById(`editInquiryAuthor-${inquiryId}`).value.trim();
            const updatedContent = document.getElementById(`editInquiryContent-${inquiryId}`).value.trim();

            if (!updatedTitle || !updatedAuthor || !updatedContent) {
                alert('ì œëª©, ì‘ì„±ì, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}`, {
                    method: 'PUT', // PUT ìš”ì²­
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: updatedTitle,
                        author: updatedAuthor,
                        content: updatedContent
                    })
                });

                if (response.ok) {
                    alert('ë¬¸ì˜ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById(`inquiryTitleDisplay-${inquiryId}`).textContent = updatedTitle;
                    document.getElementById(`inquiryAuthorDisplay-${inquiryId}`).textContent = updatedAuthor;
                    document.getElementById(`inquiryContentDisplay-${inquiryId}`).textContent = updatedContent;
                    cancelInquiryEdit(inquiryId); // ìˆ˜ì • ëª¨ë“œ ë‹«ê¸°
                    fetchInquiries(); // ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì •ë ¬/í•„í„°ë§ ë“±ì´ ì ìš©ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('ë¬¸ì˜ê¸€ ìˆ˜ì • ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ë¬¸ì˜ê¸€ ìˆ˜ì • ì‹¤íŒ¨:', response.status, errorData);
                }
            } catch (error) {
                console.error('ë¬¸ì˜ê¸€ ìˆ˜ì • ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ë¬¸ì˜ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ê³¼ ë™ì¼)
        async function fetchComments(inquiryId, page = 1) {
            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}/comments?page=${page}`);
                if (response.ok) {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        const data = await response.json();
                        renderComments(inquiryId, data.comments, data.currentPage, data.totalPages, data.totalComments);
                    } else {
                        const textResponse = await response.text();
                        console.error('>>> Received non-JSON response for comments (Content-Type:', contentType, '):', textResponse);
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`ë¬¸ì˜ ${inquiryId}ì˜ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (HTTP Status: ${response.status}, Response Text: ${errorText}).`);
                }
            } catch (error) {
                console.error(`ë¬¸ì˜ ${inquiryId}ì˜ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜:`, error);
            }
        }

        // ëŒ“ê¸€ ë Œë”ë§ (ê¸°ì¡´ê³¼ ë™ì¼)
        function renderComments(inquiryId, comments, currentPage, totalPages, totalComments) {
            const commentList = document.getElementById(`commentList-${inquiryId}`);
            commentList.innerHTML = '';
            
            // ğŸ“Œ ê´€ë¦¬ì comment ì˜† ê´„í˜¸ ë° ìˆ«ì í‘œì‹œ ë¡œì§ ë³€ê²½
            const commentCountDisplaySpan = document.getElementById(`commentCountDisplay-${inquiryId}`);
            if (totalComments > 0) {
                commentCountDisplaySpan.textContent = `(${totalComments})`;
            } else {
                commentCountDisplaySpan.textContent = ''; // 0ê°œì¼ ë•ŒëŠ” ê´„í˜¸ë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }

            const paginationInfoDiv = document.getElementById(`commentPaginationInfo-${inquiryId}`);
            const safeTotalComments = totalComments || 0;
            const safeTotalPages = totalPages || 1;

            if (safeTotalComments === 0) {
                paginationInfoDiv.innerHTML = '';
            } else {
                paginationInfoDiv.innerHTML = `ì´ ëŒ“ê¸€: ${safeTotalComments}ê°œ (í˜ì´ì§€ ${currentPage}/${safeTotalPages})`;
            }

            comments.forEach(comment => {
                const li = document.createElement('li');
                li.className = 'comment-item';
                // ğŸ“Œ ëŒ“ê¸€ ë‚´ìš© í‘œì‹œ ë° ìˆ˜ì • í¼ êµ¬ì¡° ë³€ê²½
                li.innerHTML = `
                    <div class="comment-item-meta">
                        <strong>${escapeHTML(comment.author || 'ìµëª…')}</strong> | ${new Date(comment.createdAt).toLocaleString()}
                        <button class="btn btn-danger btn-sm float-end ms-2" onclick="deleteComment('${inquiryId}', '${comment._id}', ${currentPage})">ì‚­ì œ</button>
                        <button class="btn btn-warning btn-sm float-end" onclick="editComment('${inquiryId}', '${comment._id}')">ìˆ˜ì •</button>
                    </div>
                    <p class="comment-content" id="commentContentDisplay-${comment._id}">${escapeHTML(comment.content)}</p>
                    
                    <div class="edit-comment-area" id="editCommentArea-${comment._id}">
                        <textarea class="form-control mb-2" id="editCommentContent-${comment._id}" rows="3"></textarea>
                        <button class="btn btn-success btn-sm" onclick="saveComment('${inquiryId}', '${comment._id}', ${currentPage})">ì €ì¥</button>
                        <button class="btn btn-secondary btn-sm ms-2" onclick="cancelEdit('${comment._id}')">ì·¨ì†Œ</button>
                    </div>
                `;
                commentList.appendChild(li);
            });

            const paginationUl = document.getElementById(`commentPagination-${inquiryId}`);
            paginationUl.innerHTML = '';

            if (safeTotalPages > 1) {
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="fetchComments('${inquiryId}', ${currentPage - 1})">&laquo;</a>`;
                paginationUl.appendChild(prevLi);

                for (let i = 1; i <= safeTotalPages; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${currentPage === i ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#" onclick="fetchComments('${inquiryId}', ${i})">${i}</a>`;
                    paginationUl.appendChild(pageLi);
                }

                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === safeTotalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="fetchComments('${inquiryId}', ${currentPage + 1})">&raquo;</a>`;
                paginationUl.appendChild(nextLi);
            }
        }

        // ğŸ“Œ ëŒ“ê¸€ ìˆ˜ì • ëª¨ë“œ í™œì„±í™” í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
        function editComment(inquiryId, commentId) {
            const displayContent = document.getElementById(`commentContentDisplay-${commentId}`);
            const editContentArea = document.getElementById(`editCommentContent-${commentId}`);
            const editArea = document.getElementById(`editCommentArea-${commentId}`);

            editContentArea.value = displayContent.textContent;
            displayContent.style.display = 'none';
            editArea.style.display = 'block'; 
        }

        // ğŸ“Œ ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
        function cancelEdit(commentId) {
            const displayContent = document.getElementById(`commentContentDisplay-${commentId}`);
            const editArea = document.getElementById(`editCommentArea-${commentId}`);

            editArea.style.display = 'none';
            displayContent.style.display = 'block';
        }

        // ğŸ“Œ ëŒ“ê¸€ ìˆ˜ì • ë‚´ìš© ì €ì¥ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
        async function saveComment(inquiryId, commentId, currentPage) {
            const updatedContent = document.getElementById(`editCommentContent-${commentId}`).value.trim();

            if (!updatedContent) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: updatedContent })
                });

                if (response.ok) {
                    alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById(`commentContentDisplay-${commentId}`).textContent = updatedContent;
                    cancelEdit(commentId);
                    fetchComments(inquiryId, currentPage);
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨:', response.status, errorData);
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ ë“±ë¡ (ê¸°ì¡´ê³¼ ë™ì¼)
        async function submitComment(inquiryId) {
            const commentInput = document.getElementById(`commentInput-${inquiryId}`);
            const content = commentInput.value.trim();
            const author = "ê´€ë¦¬ì";

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, content })
                });

                if (response.ok) {
                    commentInput.value = '';
                    fetchComments(inquiryId, 1);
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:', response.status, errorData);
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ (ê¸°ì¡´ê³¼ ë™ì¼)
        async function deleteComment(inquiryId, commentId, currentPage) {
            if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            try {
                const response = await fetch(`${window.location.origin}/customer/inquiries/${inquiryId}/comments/${commentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    fetchComments(inquiryId, currentPage);
                } else {
                    const errorData = await response.json().catch(() => response.text());
                    alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: ' + (errorData.message || errorData || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:', response.status, errorData);
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œë¡œ ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        document.addEventListener('DOMContentLoaded', fetchInquiries);
    </script>
</body>

</html>
