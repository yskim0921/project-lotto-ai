import os
import time
import textwrap
import streamlit as st
from dotenv import load_dotenv
from openai import OpenAI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0) í™˜ê²½ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
API_KEY = (os.getenv("OPENAI_API_KEY") or "").strip()
if not API_KEY:
    raise RuntimeError("OPENAI_API_KEYê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .envë¥¼ í™•ì¸í•˜ì„¸ìš”.")
client = OpenAI(api_key=API_KEY)

st.set_page_config(page_title="ìš°ë¦¬ ë¹„ì„œ", page_icon="ğŸ‘©â€ğŸ’¼", layout="centered")
st.title("ğŸ‘©â€ğŸ’¼ ìš°ë¦¬ ë¹„ì„œ")
st.caption("ì›í•˜ì‹œëŠ” ì§ˆë¬¸ì„ ë§ì”€í•´ ì£¼ì‹œë©´ ìƒì„¸íˆ ì„¤ëª… ë“œë¦¬ê² ìŠµë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ì‚¬ì´ë“œë°” ì˜µì…˜ (ìš´ë™ ëª©í‘œ/ë¶€ìœ„ ì„ íƒ ìœ„ì ¯ í¬í•¨)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("âš™ï¸ ì¶”ì²œ ì˜µì…˜")
    model = "gpt-3.5-turbo"

    goal = st.radio(
        "ì§€ì› ëª©ë¡",
        ["ì´ìš© ë°©ë²•", "ë°©ì²­ ì‹ ì²­", "ë¡œë˜ ë‹¹ì²¨ í™•ì¸"],
        index=0, horizontal=False
    )

    streaming = st.checkbox("ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ", value=False)

    if st.button("ğŸ§¹ ëŒ€í™” ì´ˆê¸°í™”"):
        st.session_state.clear()
        st.experimental_rerun()
        
    

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ì„¸ì…˜ ìƒíƒœ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages = []

# ì‹œìŠ¤í…œ ê°€ì´ë“œ(í”„ë¡¬í”„íŠ¸) ìƒì„±
SYSTEM_GUIDE = textwrap.dedent(f"""
ë„ˆëŠ” ìš°ë¦¬ í™ˆí˜ì´ì§€ ì¤‘ì— ëª‡ê°œì˜ í˜ì´ì§€ë¥¼ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ëŠ” ìš°ë¦¬ ë¹„ì„œì•¼.
ì•„ë˜ ì¡°ê±´ì„ ë°˜ì˜í•´ì„œ ì¹œì ˆ í•˜ê²Œ ì„¤ëª… í•´ì£¼ë©´ ë¼.

[ì‚¬ìš©ì ì¡°ê±´]
- ëª©í‘œ: {goal}

[ì œì‹œ í˜•ì‹]
1) í•œ ì¤„ ìš”ì•½
2) ë‹¨ê³„ë³„ ì•ˆë‚´(ë²ˆí˜¸ ëª©ë¡)
3) ìì£¼ ë¬»ëŠ” ì§ˆë¬¸(FAQ) 3ê°œ
4) ë‹¤ìŒ ì¶”ì²œ ì§ˆë¬¸ 3ê°œ

[ì›ì¹™]
- ì§§ì€ ë¬¸ì¥ ìœ„ì£¼, í•µì‹¬ë¶€í„° ì œì‹œ
- ë²„íŠ¼/ë©”ë‰´ ê²½ë¡œëŠ” êµµê²Œ(**ê²½ë¡œ**)ë¡œ í‘œì‹œ
- ì‹¤ì œ ì…ë ¥ê°’/ì˜ˆì‹œëŠ” ì½”ë“œë¸”ë¡ì´ ì•„ë‹Œ ì¸ë¼ì¸ìœ¼ë¡œ ì œì‹œ
- ëª¨ë¥´ë©´ ëª¨ë¥¸ë‹¤ê³  ë§í•˜ê³ , ê°€ëŠ¥í•œ ì¶”ì •ì€ 'ì˜ˆ: â€¦'ë¡œ êµ¬ë¶„
- ëª©í‘œ ì´ì™¸ì—ëŠ” ë‹µë³€ì„ í•˜ì§€ ë§ˆ.
""").strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ê³¼ê±° ëŒ€í™” ë Œë”ë§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for m in st.session_state.messages:
    with st.chat_message(m["role"]):
        st.markdown(m["content"])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ì‚¬ìš©ì ì…ë ¥ & ëª¨ë¸ í˜¸ì¶œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
placeholder_hint_by_goal = {
    "ì´ìš© ë°©ë²•": "ì˜ˆ) í™ˆí˜ì´ì§€ ì´ìš© ë°©ë²• ì•Œë ¤ì¤˜ / ê²°ì œ ê³¼ì • í¬í•¨",
    "ë°©ì²­ ì‹ ì²­": "ì˜ˆ) ë°©ì²­ ì‹ ì²­ ì ˆì°¨ / ë‹¹ì¼ í˜„ì¥ ì‹ ì²­ ê°€ëŠ¥?",
    "ë¡œë˜ ë‹¹ì²¨ í™•ì¸": "ì˜ˆ) 1120íšŒ ë‹¹ì²¨ ë²ˆí˜¸ í™•ì¸ / ìë™ vs ìˆ˜ë™ í™•ë¥ ?"
}
default_hint = placeholder_hint_by_goal.get(goal, "ì˜ˆ) ì•ˆë‚´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.")

# âœ… ì‚¬ìš©ì ì…ë ¥ ìœ„ì ¯ ì¶”ê°€
user_prompt = st.chat_input(default_hint)

if user_prompt:
    # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ/ì €ì¥
    st.session_state.messages.append({"role": "user", "content": user_prompt})
    with st.chat_message("user"):
        st.markdown(user_prompt)

    # ë‹¨ì¼ ë¬¸ìì—´ í•©ì„± (Responses APIëŠ” ë¬¸ìì—´ input ê°€ëŠ¥)
    composed = f"[SYSTEM]\n{SYSTEM_GUIDE}\n\n[USER]\n{user_prompt}"

    t0 = time.perf_counter()
    try:
        if streaming:
            with st.chat_message("assistant"):
                ph = st.empty()
                chunks = []
                with client.responses.stream(
                    model=model,
                    input=composed,
                    temperature=0.4,
                ) as stream:
                    for event in stream:
                        if event.type == "response.output_text.delta":
                            chunks.append(event.delta)
                            ph.markdown("".join(chunks))
                    stream.until_done()
                answer = "".join(chunks) if chunks else "(ì‘ë‹µ ì—†ìŒ)"
        else:
            resp = client.responses.create(
                model=model,
                input=composed,
                temperature=0.4,
            )
            answer = getattr(resp, "output_text", None) or str(resp)
            with st.chat_message("assistant"):
                st.markdown(answer)

        # ì‘ë‹µ ì €ì¥
        st.session_state.messages.append({"role": "assistant", "content": answer})

        # ë¶€ê°€ ì •ë³´
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        with st.expander("â’¾ ì‹œìŠ¤í…œ ê°€ì´ë“œ(í”„ë¡¬í”„íŠ¸)", expanded=False):
            st.code(SYSTEM_GUIDE, language="markdown")
        st.caption(f"â±ï¸ ì‘ë‹µ ì‹œê°„: {elapsed_ms} ms")

        # ë‹¤ìš´ë¡œë“œ(ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸)
        st.download_button(
            label="ğŸ“¥ ì´ë²ˆ ë‹µë³€ ë‹¤ìš´ë¡œë“œ (.md)",
            data=answer.encode("utf-8"),
            file_name="site_helper_answer.md",
            mime="text/markdown",
            use_container_width=True,
        )

    except Exception as e:
        with st.chat_message("assistant"):
            st.error(f"OpenAI í˜¸ì¶œ ì‹¤íŒ¨: {e}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) ì•ˆì „ ì•ˆë‚´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.caption("âš ï¸ ë³¸ ë‚´ìš©ì€ ì°¸ê³ ìš© ê°€ì´ë“œì…ë‹ˆë‹¤.")
